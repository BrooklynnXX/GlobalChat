<!DOCTYPE html>
<html>
<head>
  <title>Gnarchat</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; }
    #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
    #messages div { margin-bottom: 8px; display: flex; align-items: center; }
    #messages img { width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; max-width: 400px; }
    #userList div { cursor: pointer; padding: 4px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
    #userList img { width: 25px; height: 25px; border-radius: 50%; margin-right: 8px; }
    #userList div.selected { background-color: #d0d0ff; }
    #status { margin: 10px 0; font-weight: bold; }
    #authForms > div { margin-bottom: 20px; }
  </style>
</head>
<body>

  <img src="GNARCHAT_LOGO.png" id="logoTop" style="width:200px; height:120px;">

  <div id="authForms">
    <div id="signupDiv">
      <h3>Sign Up</h3>
      <input type="email" id="signupEmail" placeholder="Email" />
      <input type="password" id="signupPassword" placeholder="Password" />
      <input type="file" id="signupPfp" accept="image/*" />
      <button id="signupBtn">Sign Up</button>
    </div>

    <div id="loginDiv">
      <h3>Log In</h3>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Log In</button>
    </div>

    <button id="logoutBtn" style="display:none;">Log Out</button>
  </div>

  <div id="status"></div>

  <div><strong>Online Users:</strong></div>
  <div id="userList">Please log in to see online users.</div>

  <div>
    <label>Chatting with: <span id="dmWith">Global Chat</span></label>
  </div>

  <div id="messages"></div>

  <input type="text" id="message" placeholder="Type your message" disabled />
  <button id="sendBtn" disabled>Send</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCPjxmzcSVEtmELZtUqCq0tb6SGMe3JRkQ",
      authDomain: "global-chat-bd90a.firebaseapp.com",
      databaseURL: "https://global-chat-bd90a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "global-chat-bd90a",
      storageBucket: "global-chat-bd90a.appspot.com",
      messagingSenderId: "1090315136333",
      appId: "1:1090315136333:web:13bea5c3c97cd067b6db04",
      measurementId: "G-NL8G2ETCCB"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // UI elements
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupPfp = document.getElementById('signupPfp');
    const signupBtn = document.getElementById('signupBtn');

    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');

    const logoutBtn = document.getElementById('logoutBtn');

    const statusDiv = document.getElementById('status');
    const userListDiv = document.getElementById('userList');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('sendBtn');
    const dmWithSpan = document.getElementById('dmWith');

    let currentUser = null;
    let selectedDMUser = null; // null = global chat
    const startTime = Date.now();
    let messagesListener = null;

    // ===== Helper to clear auth inputs =====
    function clearAuthInputs() {
      signupEmail.value = '';
      signupPassword.value = '';
      signupPfp.value = '';
      loginEmail.value = '';
      loginPassword.value = '';
    }

    // ===== Upload profile pic to Firebase Storage and return the download URL =====
    async function uploadProfilePic(file, uid) {
      const ref = storage.ref().child('profile_pics/' + uid);
      await ref.put(file);
      return await ref.getDownloadURL();
    }

    // ===== Authentication =====

    signupBtn.onclick = async () => {
      const email = signupEmail.value.trim();
      const pass = signupPassword.value.trim();
      const file = signupPfp.files[0];
      if (!email || !pass) {
        alert('Enter email and password to sign up');
        return;
      }
      statusDiv.textContent = 'Signing up...';

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
        currentUser = userCredential.user;

        let profilePicUrl = null;
        if (file) {
          profilePicUrl = await uploadProfilePic(file, currentUser.uid);
        }

        // Save profile pic URL in DB
        await db.ref('users/' + currentUser.uid).set({
          email: currentUser.email,
          profilePic: profilePicUrl || null
        });

        statusDiv.textContent = 'Sign up successful! You are logged in.';
        clearAuthInputs();
      } catch (e) {
        statusDiv.textContent = 'Error signing up: ' + e.message;
      }
    };

    loginBtn.onclick = async () => {
      const email = loginEmail.value.trim();
      const pass = loginPassword.value.trim();
      if (!email || !pass) {
        alert('Enter email and password to log in');
        return;
      }
      statusDiv.textContent = 'Logging in...';

      try {
        await auth.signInWithEmailAndPassword(email, pass);
        statusDiv.textContent = 'Logged in successfully!';
        clearAuthInputs();
      } catch (e) {
        statusDiv.textContent = 'Login error: ' + e.message;
      }
    };

    logoutBtn.onclick = () => {
      auth.signOut();
    };

    // ===== User presence and chat =====

    // Update online users list excluding self, with PFP
    async function updateUserList(users) {
      userListDiv.innerHTML = '';
      if (!currentUser) {
        userListDiv.textContent = 'Please log in to see online users.';
        return;
      }
      const otherUsers = Object.keys(users || {}).filter(u => u !== currentUser.uid);
      if (otherUsers.length === 0) {
        userListDiv.textContent = 'No other users online.';
        return;
      }
      for (const uid of otherUsers) {
        // Get user info from DB to get profilePic and email
        const snapshot = await db.ref('users/' + uid).get();
        const userInfo = snapshot.val();
        const emailOrName = userInfo?.email || uid;
        const profilePic = userInfo?.profilePic || 'https://via.placeholder.com/30?text=?';

        const div = document.createElement('div');
        div.innerHTML = `<img src="${profilePic}" alt="pfp"/>` + emailOrName;
        if (uid === selectedDMUser) div.classList.add('selected');
        div.onclick = () => {
          if (selectedDMUser === uid) {
            selectedDMUser = null;
            dmWithSpan.textContent = 'Global Chat';
          } else {
            selectedDMUser = uid;
            dmWithSpan.textContent = 'DM with ' + emailOrName;
          }
          clearMessages();
          attachMessagesListener();
          updateUserList(users);
        };
        userListDiv.appendChild(div);
      }
    }

    // Clear chat messages
    function clearMessages() {
      messagesDiv.innerHTML = '';
    }

    // Attach listener to messages based on DM or global chat, show PFP for each message
    function attachMessagesListener() {
      if (messagesListener) {
        if (selectedDMUser === null) {
          db.ref('messages').off('child_added', messagesListener);
        } else {
          db.ref('privateMessages').off('child_added', messagesListener);
        }
        messagesListener = null;
      }

      if (selectedDMUser === null) {
        messagesListener = async snapshot => {
          const msg = snapshot.val();
          if (msg.timestamp > startTime && (!msg.to)) {
            const userSnapshot = await db.ref('users/' + msg.uid).get();
            const userInfo = userSnapshot.val();
            const profilePic = userInfo?.profilePic || 'https://via.placeholder.com/30?text=?';

            const div = document.createElement('div');
            div.innerHTML = `<img src="${profilePic}" alt="pfp" />` + (msg.username || msg.email || 'Unknown') + ': ' + msg.text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        };
        db.ref('messages').on('child_added', messagesListener);
      } else {
        messagesListener = async snapshot => {
          const msg = snapshot.val();
          if (msg.timestamp > startTime &&
              ((msg.from === currentUser.uid && msg.to === selectedDMUser) ||
               (msg.from === selectedDMUser && msg.to === currentUser.uid))) {

            const userIdForPic = msg.from === currentUser.uid ? currentUser.uid : selectedDMUser;
            const userSnapshot = await db.ref('users/' + userIdForPic).get();
            const userInfo = userSnapshot.val();
            const profilePic = userInfo?.profilePic || 'https://via.placeholder.com/30?text=?';

            const div = document.createElement('div');
            div.innerHTML = `<img src="${profilePic}" alt="pfp" />` + (msg.from === currentUser.uid ? 'You' : userInfo.email || msg.from) + ': ' + msg.text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        };
        db.ref('privateMessages').on('child_added', messagesListener);
      }
    }

    // ===== User presence system =====
    // Store online users with UID as key
    function registerUserPresence(uid) {
      const userRef = db.ref('activeUsers/' + uid);
      userRef.set(true);
      userRef.onDisconnect().remove();
    }

    // Listen to online users changes
    db.ref('activeUsers').on('value', snapshot => {
      updateUserList(snapshot.val());
    });

    // ===== Send message =====

    sendBtn.onclick = () => {
      if (!currentUser) {
        alert('Please log in first!');
        return;
      }
      const text = messageInput.value.trim();
      if (!text) return;

      if (selectedDMUser === null) {
        db.ref('messages').push({
          username: currentUser.email,
          uid: currentUser.uid,
          text,
          timestamp: Date.now()
        });
      } else {
        db.ref('privateMessages').push({
          from: currentUser.uid,
          to: selectedDMUser,
          text,
          timestamp: Date.now()
        });
      }
      messageInput.value = '';
    };

    // Send on enter
    messageInput.addEventListener('keyup', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // ===== Auth state listener =====
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        statusDiv.textContent = 'Logged in as: ' + user.email;
        signupBtn.style.display = 'none';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        messageInput.disabled = false;
        sendBtn.disabled = false;

        registerUserPresence(user.uid);

        attachMessagesListener();

      } else {
        statusDiv.textContent = 'Not logged in.';
        signupBtn.style.display = 'inline-block';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        clearMessages();
      }
    });
  </script>
</body>
</html>
