<!DOCTYPE html>
<html>
<head>
  <title>Gnarchat</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; }
    #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
    #messages div { margin-bottom: 8px; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; max-width: 400px; }
    #userList div { cursor: pointer; padding: 4px; border-bottom: 1px solid #eee; }
    #userList div.selected { background-color: #d0d0ff; }
    #status { margin: 10px 0; font-weight: bold; }
    #authForms > div { margin-bottom: 20px; }
    #googleSignInBtn { background-color: #4285F4; color: white; border: none; cursor: pointer; }
    #googleSignInBtn:hover { background-color: #357ae8; }
  </style>
</head>
<body>

  <img src="GNARCHAT_LOGO.png" id="logoTop">

  <div id="authForms">
    <div id="signupDiv">
      <h3>Sign Up</h3>
      <input type="email" id="signupEmail" placeholder="Email" />
      <input type="password" id="signupPassword" placeholder="Password" />
      <button id="signupBtn">Sign Up</button>
    </div>

    <div id="loginDiv">
      <h3>Log In</h3>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Log In</button>
    </div>

    <button id="googleSignInBtn">Sign In with Google</button>

    <button id="logoutBtn" style="display:none;">Log Out</button>
  </div>

  <div id="status"></div>

  <div><strong>Online Users:</strong></div>
  <div id="userList">Please log in to see online users.</div>

  <div>
    <label>Chatting with: <span id="dmWith">Global Chat</span></label>
  </div>

  <div id="messages"></div>

  <input type="text" id="message" placeholder="Type your message" disabled />
  <button id="sendBtn" disabled>Send</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCPjxmzcSVEtmELZtUqCq0tb6SGMe3JRkQ",
      authDomain: "global-chat-bd90a.firebaseapp.com",
      databaseURL: "https://global-chat-bd90a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "global-chat-bd90a",
      storageBucket: "global-chat-bd90a.firebasestorage.app",
      messagingSenderId: "1090315136333",
      appId: "1:1090315136333:web:13bea5c3c97cd067b6db04",
      measurementId: "G-NL8G2ETCCB"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // UI elements
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupBtn = document.getElementById('signupBtn');

    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');

    const googleSignInBtn = document.getElementById('googleSignInBtn');

    const logoutBtn = document.getElementById('logoutBtn');

    const statusDiv = document.getElementById('status');
    const userListDiv = document.getElementById('userList');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('sendBtn');
    const dmWithSpan = document.getElementById('dmWith');

    let currentUser = null;
    let selectedDMUser = null; // null = global chat
    const startTime = Date.now();

    // Track message listener so we can detach it
    let messagesListener = null;

    // ===== Authentication =====

    signupBtn.onclick = () => {
      const email = signupEmail.value.trim();
      const pass = signupPassword.value.trim();
      if (!email || !pass) {
        alert('Enter email and password to sign up');
        return;
      }
      auth.createUserWithEmailAndPassword(email, pass)
        .then(() => {
          statusDiv.textContent = 'Sign up successful! You are logged in.';
          clearAuthInputs();
        })
        .catch(e => {
          statusDiv.textContent = 'Error signing up: ' + e.message;
        });
    };

    loginBtn.onclick = () => {
      const email = loginEmail.value.trim();
      const pass = loginPassword.value.trim();
      if (!email || !pass) {
        alert('Enter email and password to log in');
        return;
      }
      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          statusDiv.textContent = 'Logged in successfully!';
          clearAuthInputs();
        })
        .catch(e => {
          statusDiv.textContent = 'Login error: ' + e.message;
        });
    };

    // Google sign-in
    googleSignInBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          statusDiv.textContent = 'Signed in with Google as ' + result.user.email;
        })
        .catch((error) => {
          statusDiv.textContent = 'Google sign-in error: ' + error.message;
        });
    };

    logoutBtn.onclick = () => {
      auth.signOut();
    };

    function clearAuthInputs() {
      signupEmail.value = '';
      signupPassword.value = '';
      loginEmail.value = '';
      loginPassword.value = '';
    }

    // ===== User presence and chat =====

    // Update online users list excluding self
    function updateUserList(users) {
      userListDiv.innerHTML = '';
      if (!currentUser) {
        userListDiv.textContent = 'Please log in to see online users.';
        return;
      }
      const otherUsers = Object.entries(users || {}).filter(([uid]) => uid !== currentUser.uid);

      if (otherUsers.length === 0) {
        userListDiv.textContent = 'No other users online.';
        return;
      }

      otherUsers.forEach(([uid, userInfo]) => {
        const div = document.createElement('div');
        div.textContent = userInfo.displayName || userInfo.email || uid;
        div.dataset.uid = uid;
        if (uid === selectedDMUser) div.classList.add('selected');
        div.onclick = () => {
          if (selectedDMUser === uid) {
            selectedDMUser = null;
            dmWithSpan.textContent = 'Global Chat';
          } else {
            selectedDMUser = uid;
            dmWithSpan.textContent = 'DM with ' + div.textContent;
          }
          clearMessages();
          attachMessagesListener();
          updateUserList(users);
        };
        userListDiv.appendChild(div);
      });
    }

    // Clear chat messages
    function clearMessages() {
      messagesDiv.innerHTML = '';
    }

    // Attach listener to messages based on DM or global chat
    function attachMessagesListener() {
      if (messagesListener) {
        if (selectedDMUser === null) {
          db.ref('messages').off('child_added', messagesListener);
        } else {
          db.ref('privateMessages').off('child_added', messagesListener);
        }
        messagesListener = null;
      }

      if (selectedDMUser === null) {
        messagesListener = snapshot => {
          const msg = snapshot.val();
          if (msg.timestamp > startTime && (!msg.to)) {
            const div = document.createElement('div');
            div.textContent = msg.username + ': ' + msg.text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        };
        db.ref('messages').on('child_added', messagesListener);
      } else {
        messagesListener = snapshot => {
          const msg = snapshot.val();
          if (msg.timestamp > startTime &&
              ((msg.from === currentUser.uid && msg.to === selectedDMUser) ||
               (msg.from === selectedDMUser && msg.to === currentUser.uid))) {
            const div = document.createElement('div');
            div.textContent = (msg.from === currentUser.uid ? 'You' : msg.from) + ': ' + msg.text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        };
        db.ref('privateMessages').on('child_added', messagesListener);
      }
    }

    // ===== User presence system =====
    // Store online users with UID as key, and email/displayName for showing
    function registerUserPresence(user) {
      const userRef = db.ref('activeUsers/' + user.uid);
      userRef.set({
        email: user.email,
        displayName: user.displayName || null
      });
      userRef.onDisconnect().remove();
    }

    // Listen to online users changes
    db.ref('activeUsers').on('value', snapshot => {
      updateUserList(snapshot.val());
    });

    // ===== Send message =====

    sendBtn.onclick = () => {
      if (!currentUser) {
        alert('Please log in first!');
        return;
      }
      const text = messageInput.value.trim();
      if (!text) return;

      if (selectedDMUser === null) {
        db.ref('messages').push({
          username: currentUser.email,
          uid: currentUser.uid,
          text,
          timestamp: Date.now()
        });
      } else {
        db.ref('privateMessages').push({
          from: currentUser.uid,
          to: selectedDMUser,
          text,
          timestamp: Date.now()
        });
      }
      messageInput.value = '';
    };

    // Send on enter
    messageInput.addEventListener('keyup', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // ===== Auth state listener =====
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        statusDiv.textContent = 'Logged in as: ' + user.email;
        signupBtn.style.display = 'none';
        loginBtn.style.display = 'none';
        googleSignInBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        messageInput.disabled = false;
        sendBtn.disabled = false;

        // Register presence with full user object (to save email/displayName)
        registerUserPresence(user);

        attachMessagesListener();
      } else {
        statusDiv.textContent = 'Not logged in.';
        signupBtn.style.display = 'inline-block';
        loginBtn.style.display = 'inline-block';
        googleSignInBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        clearMessages();
      }
    });
  </script>
</body>
</html>
